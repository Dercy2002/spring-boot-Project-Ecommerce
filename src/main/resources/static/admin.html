<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - E-commerce</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .admin-header { background-color: #198754; color: white; padding: 20px; }
        .admin-header h2 { margin: 0; }
        .sidebar { min-height: 100vh; background-color: #343a40; }
        .sidebar a { color: white; padding: 10px 20px; display: block; text-decoration: none; }
        .sidebar a:hover { background-color: #495057; }
        .loading-spinner { display: none; text-align: center; padding: 20px; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar d-flex flex-column">
            <h4 class="text-white text-center py-3">Admin</h4>
            <a href="#" onclick="loadProducts()">Gérer les Produits</a>
            <a href="#" onclick="loadUsers()">Gérer les Utilisateurs</a>
            <a href="#" onclick="loadOrders()">Commandes</a>
            <a href="#" onclick="logout()">Déconnexion</a>
        </div>
        <div class="col-md-10">
            <div class="admin-header d-flex justify-content-between align-items-center">
                <h2>Tableau de Bord Administrateur</h2>
                <span id="adminName" class="fw-bold"></span>
            </div>
            <div class="p-4" id="mainContent">
                <h4>Bienvenue dans le panneau d'administration.</h4>
                <p>Sélectionnez une action dans le menu.</p>
            </div>
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    if (!token) {
        window.location.href = "/login.html";
    }

    document.getElementById("adminName").innerText = "Connecté en tant qu'ADMIN";

    function showLoading(show) {
        document.getElementById("loadingSpinner").style.display = show ? "block" : "none";
        document.getElementById("mainContent").style.display = show ? "none" : "block";
    }

    async function loadProducts() {
        showLoading(true);
        const content = document.getElementById("mainContent");
        content.innerHTML = `
            <h4>Liste des Produits</h4>
            <button class="btn btn-success mb-3" onclick="showAddProductForm()">+ Ajouter un produit</button>
            <div id="productList" class="row g-3 mt-3"></div>
            <div id="addProductForm" class="mt-4"></div>
        `;

        try {
            const response = await fetch("/api/products", {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error("Session expirée. Veuillez vous reconnecter.");
                }
                throw new Error(`Erreur HTTP ${response.status}`);
            }
            const products = await response.json();
            const productList = document.getElementById("productList");

            if (products.length === 0) {
                productList.innerHTML = "<p>Aucun produit trouvé.</p>";
                showLoading(false);
                return;
            }

            products.forEach(product => {
                const card = document.createElement("div");
                card.className = "col-md-4";
                card.innerHTML = `
                    <div class="card h-100 shadow-sm">
                        <img src="${product.imageUrl}" class="card-img-top" alt="${product.name}" style="max-height: 200px; object-fit: contain;">
                        <div class="card-body">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text">${product.description}</p>
                            <p class="text-success fw-bold">${product.price} €</p>
                            <p>Quantité: ${product.quantity}</p>
                            <button class="btn btn-primary btn-sm me-2" onclick='showEditProductForm(${JSON.stringify(product)})'>Modifier</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">Supprimer</button>
                        </div>
                    </div>
                `;
                productList.appendChild(card);
            });
        } catch (error) {
            content.innerHTML = `<div class="alert alert-danger">Erreur lors du chargement des produits : ${error.message}</div>`;
        } finally {
            showLoading(false);
        }
    }

    function showAddProductForm() {
        const formDiv = document.getElementById("addProductForm");
        formDiv.innerHTML = `
            <h5>Ajouter un nouveau produit</h5>
            <form id="productForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">Nom du produit</label>
                    <input type="text" id="productName" name="name" class="form-control" placeholder="Nom du produit" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="productDescription" name="description" class="form-control" placeholder="Description" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Prix (€)</label>
                    <input type="number" id="productPrice" name="price" class="form-control" placeholder="Prix" step="0.01" min="0.01" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Quantité</label>
                    <input type="number" id="productQuantity" name="quantity" class="form-control" placeholder="Quantité" min="0" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Image</label>
                    <input type="file" id="productImage" name="image" class="form-control" accept="image/jpeg,image/png" required>
                </div>
                <button type="submit" class="btn btn-primary">Ajouter</button>
            </form>
        `;

        document.getElementById("productForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            showLoading(true);

            const name = document.getElementById("productName").value.trim();
            const description = document.getElementById("productDescription").value.trim();
            const price = parseFloat(document.getElementById("productPrice").value);
            const quantity = parseInt(document.getElementById("productQuantity").value);
            const image = document.getElementById("productImage").files[0];

            console.log("Form inputs:", { name, description, price, quantity, image });

            if (!name) {
                alert("Le nom du produit est requis.");
                showLoading(false);
                return;
            }
            if (!description) {
                alert("La description est requise.");
                showLoading(false);
                return;
            }
            if (isNaN(price) || price <= 0) {
                alert("Le prix doit être supérieur à 0.");
                showLoading(false);
                return;
            }
            if (isNaN(quantity) || quantity < 0) {
                alert("La quantité ne peut pas être négative.");
                showLoading(false);
                return;
            }
            if (!image) {
                alert("Une image est requise.");
                showLoading(false);
                return;
            }

            const formData = new FormData();
            const productData = {
                name: name,
                description: description,
                price: price,
                quantity: quantity
            };
            formData.append("product", new Blob([JSON.stringify(productData)], { type: "application/json" }));
            formData.append("image", image);

            console.log("FormData product part:", JSON.stringify(productData));

            try {
                const response = await fetch("/api/products", {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + token },
                    body: formData
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Erreur HTTP ${response.status}`);
                }
                alert("Produit ajouté avec succès !");
                loadProducts();
            } catch (error) {
                console.error("Error during product creation:", error);
                alert("Erreur lors de l'ajout : " + error.message);
            } finally {
                showLoading(false);
            }
        });
    }

    function showEditProductForm(product) {
        const formDiv = document.getElementById("addProductForm");
        formDiv.innerHTML = `
            <h5>Modifier le produit</h5>
            <form id="editProductForm" enctype="multipart/form-data">
                <div class="mb-3">
                    <label class="form-label">Nom du produit</label>
                    <input type="text" id="productName" name="name" class="form-control" value="${product.name}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="productDescription" name="description" class="form-control" required>${product.description}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Prix (€)</label>
                    <input type="number" id="productPrice" name="price" class="form-control" value="${product.price}" step="0.01" min="0.01" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Quantité</label>
                    <input type="number" id="productQuantity" name="quantity" class="form-control" value="${product.quantity}" min="0" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Image (laisser vide pour conserver l'image actuelle)</label>
                    <input type="file" id="productImage" name="image" class="form-control" accept="image/jpeg,image/png">
                </div>
                <button type="submit" class="btn btn-primary">Mettre à jour</button>
            </form>
        `;

        document.getElementById("editProductForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            showLoading(true);

            const name = document.getElementById("productName").value.trim();
            const description = document.getElementById("productDescription").value.trim();
            const price = parseFloat(document.getElementById("productPrice").value);
            const quantity = parseInt(document.getElementById("productQuantity").value);

            console.log("Edit form inputs:", { name, description, price, quantity });

            if (!name) {
                alert("Le nom du produit est requis.");
                showLoading(false);
                return;
            }
            if (!description) {
                alert("La description est requise.");
                showLoading(false);
                return;
            }
            if (isNaN(price) || price <= 0) {
                alert("Le prix doit être supérieur à 0.");
                showLoading(false);
                return;
            }
            if (isNaN(quantity) || quantity < 0) {
                alert("La quantité ne peut pas être négative.");
                showLoading(false);
                return;
            }

            const formData = new FormData();
            const productData = {
                name: name,
                description: description,
                price: price,
                quantity: quantity
            };
            formData.append("product", new Blob([JSON.stringify(productData)], { type: "application/json" }));
            const image = document.getElementById("productImage").files[0];
            if (image) {
                formData.append("image", image);
            }

            try {
                const response = await fetch(`/api/products/${product.id}`, {
                    method: "PUT",
                    headers: { "Authorization": "Bearer " + token },
                    body: formData
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Erreur HTTP ${response.status}`);
                }
                alert("Produit mis à jour avec succès !");
                loadProducts();
            } catch (error) {
                console.error("Error during product update:", error);
                alert("Erreur lors de la mise à jour : " + error.message);
            } finally {
                showLoading(false);
            }
        });
    }

    async function deleteProduct(id) {
        if (!confirm("Voulez-vous vraiment supprimer ce produit ?")) return;
        showLoading(true);
        try {
            const response = await fetch(`/api/products/${id}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error("Session expirée. Veuillez vous reconnecter.");
                }
                throw new Error(`Erreur HTTP ${response.status}`);
            }
            alert("Produit supprimé avec succès !");
            loadProducts();
        } catch (error) {
            alert("Erreur lors de la suppression : " + error.message);
        } finally {
            showLoading(false);
        }
    }

    async function loadUsers() {
        showLoading(true);
        const content = document.getElementById("mainContent");
        content.innerHTML = `<h4>Liste des Utilisateurs</h4><div id="userList" class="list-group mt-3"></div>`;

        try {
            const response = await fetch("/api/users", {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error("Session expirée. Veuillez vous reconnecter.");
                }
                throw new Error(`Erreur HTTP ${response.status}`);
            }
            const users = await response.json();
            const list = document.getElementById("userList");

            if (users.length === 0) {
                list.innerHTML = "<p>Aucun utilisateur trouvé.</p>";
                showLoading(false);
                return;
            }

            users.forEach(user => {
                const item = document.createElement("div");
                item.className = "list-group-item";
                item.innerHTML = `
                    <strong>${user.name}</strong> - ${user.email} (${user.role})
                `;
                list.appendChild(item);
            });
        } catch (error) {
            content.innerHTML = `<div class="alert alert-danger">Erreur lors du chargement des utilisateurs : ${error.message}</div>`;
        } finally {
            showLoading(false);
        }
    }

    function loadOrders() {
        const content = document.getElementById("mainContent");
        content.innerHTML = `
            <h4>Commandes</h4>
            <p>Fonctionnalité à implémenter...</p>
        `;
    }

    function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>